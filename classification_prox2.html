
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Classification Survey</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 800px; }
    img { max-width: 620px; display: block; margin: 10px 0; border: 1px solid #ccc; }
    .options label { margin-right: 15px; }
    .result { margin-top: 20px; }
    .correct { color: green; }
    .incorrect { color: red; }
    button { margin-top: 20px; padding: 10px 16px; font-size: 16px; cursor: pointer; }
    label { display: block; margin-top: 10px; }
    input[type="text"], input[type="number"] { width: 200px; padding: 5px; margin-top: 5px; }
  </style>
</head>
<body>
<h1>Classification Survey</h1>

<div id="start-container">
  <form id="userForm">
    <label for="country">Country:</label>
    <input type="text" id="country" required>

    <label for="years">Years of profession:</label>
    <input type="number" id="years" min="0" max="100" required>

    <label for="specialty">Medical specialty:</label>
    <input type="text" id="specialty" required>

    <button id="startBtn" type="submit" style="margin-top:20px;">Start Survey</button>
  </form>
</div>

<div id="survey" style="display:none;"></div>
<button id="finishBtn" style="display:none;" onclick="finishSurvey()">Finish Survey</button>

<div id="result" class="result"></div>

<script>
const images = [];
const categories = ["Normal", "Suspected_pulmonary_infarction", "Not_evaluable"];
const googleSheetsUrl = "https://script.google.com/macros/s/AKfycbxioG9f0ROIY2losZDwQwOA3PLd1Jfc9A0-FOvmEfSAGEhsryVInzvfVoL0YAnyqo6d5Q/exec";
const proxyUrl = "https://cors-anywhere.herokuapp.com/";

let answers = [];
let userInfo = {};

const startContainer = document.getElementById("start-container");
const surveyDiv = document.getElementById("survey");
const finishBtn = document.getElementById("finishBtn");
const resultDiv = document.getElementById("result");
const userForm = document.getElementById("userForm");

userForm.addEventListener('submit', function(event) {
  event.preventDefault();
  userInfo.country = document.getElementById('country').value.trim();
  userInfo.years = document.getElementById('years').value.trim();
  userInfo.specialty = document.getElementById('specialty').value.trim();

  if (!userInfo.country || !userInfo.years || !userInfo.specialty) {
    alert("Please fill in all fields.");
    return;
  }

  startContainer.style.display = "none";
  surveyDiv.style.display = "block";
  finishBtn.style.display = "inline-block";

  createSurvey();
});

function createSurvey() {
  images.forEach((imgData, idx) => {
    const div = document.createElement("div");
    div.classList.add("image-container");

    let optionsHTML = "";
    categories.forEach(cat => {
      optionsHTML += `
        <label>
          <input type="radio" name="resp_${idx}" value="${cat}"> ${cat}
        </label>`;
    });

    div.innerHTML = `
      <p><strong>${imgData.filename}</strong></p>
      <img src="data:${imgData.mime};base64,${imgData.base64}">
      <div class="options" id="options_${idx}">
        ${optionsHTML}
      </div>
      <hr>
    `;
    surveyDiv.appendChild(div);

    answers.push({
      filename: imgData.filename,
      correct: imgData.category,
      selected: null
    });
  });
}

function finishSurvey() {
  let allAnswered = true;

  answers.forEach((ans, idx) => {
    const radios = document.getElementsByName("resp_" + idx);
    const selected = Array.from(radios).find(r => r.checked);
    if (selected) {
      ans.selected = selected.value;
    } else {
      allAnswered = false;
    }
  });

  if (!allAnswered) {
    alert("Please answer all images before finishing.");
    return;
  }

  sendResultsToGoogleSheet();
  showErrors();
  surveyDiv.style.display = "none";
  finishBtn.style.display = "none";
}

function sendResultsToGoogleSheet() {
  const payload = answers.map(r => ({
    country: userInfo.country,
    years: userInfo.years,
    specialty: userInfo.specialty,
    filename: r.filename,
    correct: r.correct,
    selected: r.selected
  }));

  fetch(proxyUrl + googleSheetsUrl, {
    method: "POST",
    body: JSON.stringify(payload),
    headers: {
      "Content-Type": "application/json"
    }
  }).then(res => {
    console.log("‚úîÔ∏è Sent results to Google Sheets via proxy");
  }).catch(err => {
    console.error("‚ùå Error sending to Sheets:", err);
  });
}

function showErrors() {
  resultDiv.innerHTML = "<h2>Results</h2>";

  const errors = answers.filter(r => r.correct !== r.selected);

  if (errors.length === 0) {
    resultDiv.innerHTML += "<p class='correct'>üéâ All answers are correct!</p>";
  } else {
    errors.forEach(err => {
      const imgData = images.find(i => i.filename === err.filename);
      if (!imgData) return;

      const div = document.createElement("div");
      div.classList.add("incorrect");
      div.innerHTML = `
        <p><strong>${err.filename}</strong></p>
        <img src="data:${imgData.mime};base64,${imgData.base64}">
        <p>‚úÖ Correct answer: <strong>${err.correct}</strong></p>
        <p>‚ùå Your answer: <strong>${err.selected}</strong></p>
        <hr>
      `;
      resultDiv.appendChild(div);
    });
  }

  const btn = document.createElement("button");
  btn.textContent = "Download results as CSV";
  btn.onclick = downloadCSV;
  resultDiv.appendChild(btn);
}

function downloadCSV() {
  let csvContent = "\ufeffcountry,years_of_profession,medical_specialty,filename,correct_answer,user_answer,correct\n";
  answers.forEach(r => {
    const isCorrect = r.correct === r.selected ? "Yes" : "No";
    csvContent += `${userInfo.country},${userInfo.years},${userInfo.specialty},${r.filename},${r.correct},${r.selected},${isCorrect}\n`;
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "survey_results.csv");
  link.style.display = "none";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
</body>
</html>
